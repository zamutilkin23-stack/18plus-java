echo import io.javalin.Javalin;
import io.javalin.http.Context;
import org.mindrot.jbcrypt.BCrypt;
import java.sql.*;
import java.util.*;
import java.nio.file.*;
import java.time.LocalDateTime;

public class App {

    private static final String DB_URL = "jdbc:h2:mem:app;DB_CLOSE_DELAY=-1";
    private static final String ADMIN_USER = "admin";
    private static final String ADMIN_PASS = "admin123";

    public static void main(String[] args) throws Exception {
        Javalin app = Javalin.create(config -> {
            config.staticFiles.add("/public", io.javalin.http.staticfiles.Location.CLASSPATH);
            config.enableDevLogging();
        }).start(7000);

        initDB();
        if (isFirstRun()) {
            createAdmin();
        }

        app.before(ctx -> log("[REQUEST] " + ctx.method() + " " + ctx.path()));

        app.get("/", ctx -> ctx.html("<h1>üîû 18+ ZONE</h1><a href='/age-gate' class='btn'>–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤–æ–∑—Ä–∞—Å—Ç</a>"));

        app.get("/age-gate", ctx -> ctx.html("""
            <h1>‚ö†Ô∏è –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –≤–æ–∑—Ä–∞—Å—Ç</h1>
            <form method='post' action='/check-age'>
                –ì–æ–¥ —Ä–æ–∂–¥–µ–Ω–∏—è: <input name='year' type='number' min='1900' max='2025' required>
                <button>–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å</button>
            </form>
            <a href='/'>‚Üê –ù–∞–∑–∞–¥</a>
        """));

        app.post("/check-age", ctx -> {
            int year = Integer.parseInt(ctx.formParam("year"));
            if (2025 - year >= 18) {
                ctx.req().getSession(true);
                ctx.redirect("/game");
            } else {
                ctx.html("<h1>‚ùå –í–∞–º –Ω–µ—Ç 18 –ª–µ—Ç!</h1><a href='/age-gate'>–ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞</a>");
            }
        });

        app.get("/game", ctx -> {
            if (ctx.req().getSession(false) == null) ctx.redirect("/age-gate");
            Card card = getRandomCard();
            if (card == null) {
                ctx.html(getLevelUpPage());
                return;
            }
            String color = getCardColor(card.level);
            String levelName = getLevelName(card.level);
            ctx.html("""
                <style>
                body { background: #1e1a2f; color: white; font-family: Arial; text-align: center; padding: 40px; }
                .card {
                    display: inline-block;
                    width: 400px;
                    padding: 30px;
                    margin: 20px;
                    border-radius: 16px;
                    font-size: 1.2em;
                    font-weight: bold;
                    color: """ + (card.level == 3 || card.level == 4 ? "white" : "black") + """;
                    background: """ + color + """;
                    box-shadow: 0 4px 15px rgba(0,0,0,0.3);
                }
                .level-tag {
                    font-size: 0.9em;
                    color: #aaa;
                    margin-bottom: 15px;
                    display: block;
                }
                .btn {
                    padding: 12px 25px;
                    margin: 10px;
                    font-size: 1.1em;
                    border: none;
                    border-radius: 8px;
                    cursor: pointer;
                    text-decoration: none;
                    display: inline-block;
                }
                .btn-ok { background: #4CAF50; color: white; }
                .btn-penalty { background: #f44336; color: white; }
                .btn:hover { transform: scale(1.05); transition: 0.3s; }
                .nav { margin-top: 30px; }
                .nav a { color: #ff4757; text-decoration: none; margin: 0 15px; }
                </style>
                <h1>üÉè –ò–ì–†–ê: –ö–ê–†–¢–û–ß–ö–ò</h1>
                <div class='card'>
                    <span class='level-tag'>""" + levelName + """</span>
                    """ + card.text + """
                </div>
                <div>
                    <a href='/game/done?id=""" + card.id + """' class='btn btn-ok'>‚úÖ –í–´–ü–û–õ–ù–ï–ù–û</a>
                    <a href='/game/penalty?id=""" + card.id + """' class='btn btn-penalty'>‚ùå –®–¢–†–ê–§</a>
                </div>
                <div class='nav'>
                    <a href='/admin'>üõ†Ô∏è –ê–¥–º–∏–Ω–∫–∞</a>
                    <a href='/'>üè† –ì–ª–∞–≤–Ω–∞—è</a>
                </div>
            """);
        });

        app.get("/game/done", ctx -> {
            if (ctx.req().getSession(false) == null) ctx.redirect("/age-gate");
            int id = Integer.parseInt(ctx.queryParam("id"));
            deleteCard(id);
            log("[GAME] –í—ã–ø–æ–ª–Ω–µ–Ω–æ: –∫–∞—Ä—Ç–æ—á–∫–∞ " + id);
            ctx.redirect("/game");
        });

        app.get("/game/penalty", ctx -> {
            if (ctx.req().getSession(false) == null) ctx.redirect("/age-gate");
            int id = Integer.parseInt(ctx.queryParam("id"));
            markAsPenalty(id);
            log("[GAME] –®—Ç—Ä–∞—Ñ: –∫–∞—Ä—Ç–æ—á–∫–∞ " + id);
            ctx.redirect("/game");
        });

        app.get("/admin/login", ctx -> ctx.html("""
            <style>body{background:#1e1a2f;color:white;text-align:center;font-family:Arial}input,button{padding:10px;margin:10px}button{background:#ff4757;color:white;border:none;cursor:pointer}</style>
            <h1>üîê –í—Ö–æ–¥ –≤ –∞–¥–º–∏–Ω–∫—É</h1>
            <form method='post' action='/admin/login'>
                <input name='username' placeholder='–õ–æ–≥–∏–Ω' required>
                <input name='password' type='password' placeholder='–ü–∞—Ä–æ–ª—å' required>
                <button>–í–æ–π—Ç–∏</button>
            </form>
            <a href='/'>‚Üê –ù–∞ –≥–ª–∞–≤–Ω—É—é</a>
        """));

        app.post("/admin/login", ctx -> {
            String user = ctx.formParam("username");
            String pass = ctx.formParam("password");
            if (ADMIN_USER.equals(user) && verifyPassword(pass)) {
                ctx.req().getSession(true).setAttribute("admin", true);
                log("[ADMIN] –í—Ö–æ–¥: " + user);
                ctx.redirect("/admin");
            } else {
                log("[ADMIN] –û—à–∏–±–∫–∞: " + user);
                ctx.html("<p style='color:red'>‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –ª–æ–≥–∏–Ω –∏–ª–∏ –ø–∞—Ä–æ–ª—å</p><a href='/admin/login'>–ü–æ–≤—Ç–æ—Ä–∏—Ç—å</a>");
            }
        });

        app.get("/admin", ctx -> {
            if (ctx.req().getSession(false) == null || ctx.req().getSession().getAttribute("admin") == null) {
                ctx.redirect("/admin/login");
            }
            List<Card> cards = getCards();
            StringBuilder list = new StringBuilder();
            list.append("<style>body{background:#1e1a2f;color:white;font-family:Arial}a{color:#ff4757}table{width:100%;border-collapse:collapse;margin:20px 0}th,td{padding:12px;text-align:left;border-bottom:1px solid #333}tr:hover{background:#2d2d2d}.btn{padding:8px 16px;background:#ff4757;color:white;text-decoration:none;border-radius:6px;margin:0 5px}.white{background:white;color:black}.yellow{background:#ffeb3b}.purple{background:#9c27b0;color:white}.red{background:#f44336;color:white}</style>")
                .append("<div style='max-width:1000px;margin:auto;padding:20px'>")
                .append("<h1>üõ°Ô∏è –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</h1>")
                .append("<a href='/admin/add-card' class='btn'>‚ûï –î–æ–±–∞–≤–∏—Ç—å –∫–∞—Ä—Ç–æ—á–∫—É</a>")
                .append("<hr><table>")
                .append("<tr><th>–¢–µ–∫—Å—Ç</th><th>–£—Ä–æ–≤–µ–Ω—å</th><th>–¶–≤–µ—Ç</th><th>–î–µ–π—Å—Ç–≤–∏—è</th></tr>");

            for (Card card : cards) {
                String levelName = getLevelName(card.level);
                String colorClass = getCardColor(card.level).replace(";", "");
                list.append("<tr>")
                    .append("<td>").append(card.text).append("</td>")
                    .append("<td>").append(levelName).append("</td>")
                    .append("<td><span style='padding:5px 10px;border-radius:5px;background:").append(colorClass).append(";color:").append((card.level == 3 || card.level == 4) ? "white" : "black").append("'>–¶–≤–µ—Ç</span></td>")
                    .append("<td>")
                    .append("<a href='/admin/edit-card?id=").append(card.id).append("' class='btn'>‚úèÔ∏è</a>")
                    .append("<a href='/admin/delete-card?id=").append(card.id).append("' class='btn' style='background:#ff3742'>üóëÔ∏è</a>")
                    .append("</td>")
                    .append("</tr>");
            }

            list.append("</table>")
                .append("<hr><a href='/game' class='btn'>üÉè –ö –∏–≥—Ä–µ</a> | ")
                .append("<a href='/admin/logout' style='color:#ffcc00'>–í—ã—Ö–æ–¥</a>")
                .append("</div>");

            ctx.html(list.toString());
        });

        app.get("/admin/add-card", ctx -> {
            if (ctx.req().getSession(false) == null || ctx.req().getSession().getAttribute("admin") == null) {
                ctx.redirect("/admin/login");
            }
            ctx.html(getCardForm(null));
        });

        app.post("/admin/add-card", ctx -> {
            String text = ctx.formParam("text");
            int level = Integer.parseInt(ctx.formParam("level"));
            saveCard(text, level);
            log("[ADMIN] –î–æ–±–∞–≤–ª–µ–Ω–∞ –∫–∞—Ä—Ç–æ—á–∫–∞: " + text);
            ctx.redirect("/admin");
        });

        app.get("/admin/edit-card", ctx -> {
            if (ctx.req().getSession(false) == null || ctx.req().getSession().getAttribute("admin") == null) {
                ctx.redirect("/admin/login");
            }
            int id = Integer.parseInt(ctx.queryParam("id"));
            Card card = getCardById(id);
            ctx.html(getCardForm(card));
        });

        app.post("/admin/edit-card", ctx -> {
            int id = Integer.parseInt(ctx.formParam("id"));
            String text = ctx.formParam("text");
            int level = Integer.parseInt(ctx.formParam("level"));
            updateCard(id, text, level);
            log("[ADMIN] –û–±–Ω–æ–≤–ª–µ–Ω–∞ –∫–∞—Ä—Ç–æ—á–∫–∞: " + id);
            ctx.redirect("/admin");
        });

        app.get("/admin/delete-card", ctx -> {
            if (ctx.req().getSession(false) == null || ctx.req().getSession().getAttribute("admin") == null) {
                ctx.redirect("/admin/login");
            }
            int id = Integer.parseInt(ctx.queryParam("id"));
            deleteCard(id);
            log("[ADMIN] –£–¥–∞–ª–µ–Ω–∞ –∫–∞—Ä—Ç–æ—á–∫–∞: " + id);
            ctx.redirect("/admin");
        });

        app.get("/admin/logout", ctx -> {
            var session = ctx.req().getSession(false);
            if (session != null) session.invalidate();
            log("[ADMIN] –í—ã—Ö–æ–¥");
            ctx.redirect("/age-gate");
        });

        app.get("/api/health", ctx -> ctx.json(Map.of("status", "ok")));

        Runtime.getRuntime().addShutdownHook(new Thread(() -> log("[SHUTDOWN] –°–µ—Ä–≤–µ—Ä –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω.")));
    }

    private static void initDB() throws SQLException {
        try (var conn = DriverManager.getConnection(DB_URL); var stmt = conn.createStatement()) {
            stmt.execute("CREATE TABLE IF NOT EXISTS cards (id IDENTITY, text VARCHAR, level INT)");
            stmt.execute("CREATE TABLE IF NOT EXISTS users (id IDENTITY, username VARCHAR, password VARCHAR)");
        }
    }

    private static boolean isFirstRun() throws SQLException {
        try (var conn = DriverManager.getConnection(DB_URL);
             var rs = conn.createStatement().executeQuery("SELECT COUNT(*) FROM users")) {
            return rs.next() && rs.getInt(1) == 0;
        }
    }

    private static void createAdmin() throws SQLException {
        String hash = BCrypt.hashpw(ADMIN_PASS, BCrypt.gensalt());
        try (var conn = DriverManager.getConnection(DB_URL);
             var ps = conn.prepareStatement("INSERT INTO users (username, password) VALUES (?, ?)")) {
            ps.setString(1, ADMIN_USER);
            ps.setString(2, hash);
            ps.executeUpdate();
        }
        log("[INIT] –ê–¥–º–∏–Ω —Å–æ–∑–¥–∞–Ω: " + ADMIN_USER);
    }

    private static boolean verifyPassword(String password) throws SQLException {
        try (var conn = DriverManager.getConnection(DB_URL);
             var ps = conn.prepareStatement("SELECT password FROM users WHERE username = ?")) {
            ps.setString(1, ADMIN_USER);
            try (var rs = ps.executeQuery()) {
                return rs.next() && BCrypt.checkpw(password, rs.getString("password"));
            }
        }
    }

    private static void saveCard(String text, int level) throws SQLException {
        try (var conn = DriverManager.getConnection(DB_URL);
             var ps = conn.prepareStatement("INSERT INTO cards (text, level) VALUES (?, ?)")) {
            ps.setString(1, text);
            ps.setInt(2, level);
            ps.executeUpdate();
        }
    }

    private static void updateCard(int id, String text, int level) throws SQLException {
        try (var conn = DriverManager.getConnection(DB_URL);
             var ps = conn.prepareStatement("UPDATE cards SET text = ?, level = ? WHERE id = ?")) {
            ps.setString(1, text);
            ps.setInt(2, level);
            ps.setInt(3, id);
            ps.executeUpdate();
        }
    }

    private static void deleteCard(int id) throws SQLException {
        try (var conn = DriverManager.getConnection(DB_URL);
             var ps = conn.prepareStatement("DELETE FROM cards WHERE id = ?")) {
            ps.setInt(1, id);
            ps.executeUpdate();
        }
    }

    private static void markAsPenalty(int id) throws SQLException {
    }

    private static Card getCardById(int id) throws SQLException {
        try (var conn = DriverManager.getConnection(DB_URL);
             var ps = conn.prepareStatement("SELECT id, text, level FROM cards WHERE id = ?")) {
            ps.setInt(1, id);
            try (var rs = ps.executeQuery()) {
                if (rs.next()) {
                    return new Card(rs.getInt("id"), rs.getString("text"), rs.getInt("level"));
                }
            }
        }
        return null;
    }

    private static List<Card> getCards() throws SQLException {
        List<Card> list = new ArrayList<>();
        try (var conn = DriverManager.getConnection(DB_URL);
             var rs = conn.createStatement().executeQuery("SELECT id, text, level FROM cards")) {
            while (rs.next()) {
                list.add(new Card(rs.getInt("id"), rs.getString("text"), rs.getInt("level")));
            }
        }
        return list;
    }

    private static Card getRandomCard() throws SQLException {
        try (var conn = DriverManager.getConnection(DB_URL);
             var rs = conn.createStatement().executeQuery("SELECT id, text, level FROM cards ORDER BY RANDOM() LIMIT 1")) {
            if (rs.next()) {
                return new Card(rs.getInt("id"), rs.getString("text"), rs.getInt("level"));
            }
        }
        return null;
    }

    private static String getCardColor(int level) {
        return switch (level) {
            case 1 -> "#ffffff";
            case 2 -> "#ffeb3b";
            case 3 -> "#9c27b0";
            case 4 -> "#f44336";
            default -> "#ffffff";
        };
    }

    private static String getLevelName(int level) {
        return switch (level) {
            case 1 -> "1. –ó–Ω–∞–∫–æ–º—Å—Ç–≤–æ";
            case 2 -> "2. –ù–∞—á–∏–Ω–∞–µ–º";
            case 3 -> "3. –ü—Ä–∏–∫–æ—Å–Ω–æ–≤–µ–Ω–∏—è";
            case 4 -> "4. –ü–æ–µ—Ö–∞–ª–∏";
            default -> "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ";
        };
    }

    private static String getLevelUpPage() {
        return """
            <script>
                const audio = new Audio('/sounds/level-up.mp3');
                audio.play().catch(e => console.log('–ê–≤—Ç–æ–≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ'));
            </script>
            <style>body{background:#1e1a2f;color:white;text-align:center;padding:40px;font-family:Arial}h1{color:#ff4757}a{color:#ff4757;text-decoration:none;font-size:1.2em}</style>
            <h1>üéâ –ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º!</h1>
            <p>–í—ã –ø—Ä–æ—à–ª–∏ –≤—Å–µ –∫–∞—Ä—Ç–æ—á–∫–∏ —Ç–µ–∫—É—â–µ–≥–æ —É—Ä–æ–≤–Ω—è!</p>
            <p>–ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π —É—Ä–æ–≤–µ–Ω—å —Å–ª–æ–∂–Ω–æ—Å—Ç–∏...</p>
            <a href='/game'>–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –∏–≥—Ä—É</a> | <a href='/admin'>üõ†Ô∏è –ê–¥–º–∏–Ω–∫–∞</a>
        """;
    }

    private static String getCardForm(Card card) {
        boolean isEdit = card != null;
        String title = isEdit ? "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–∞—Ä—Ç–æ—á–∫—É" : "–î–æ–±–∞–≤–∏—Ç—å –∫–∞—Ä—Ç–æ—á–∫—É";
        String action = isEdit ? "/admin/edit-card" : "/admin/add-card";
        String idField = isEdit ? "<input type='hidden' name='id' value='" + card.id + "'>" : "";
        return """
            <style>body{background:#1e1a2f;color:white;font-family:Arial}input,select,button{padding:10px;margin:5px;width:300px}button{background:#ff4757;color:white;border:none;cursor:pointer}</style>
            <div style='text-align:center;padding:40px'>
                <h1>""" + title + """</h1>
                <form method='post' action='""" + action + """'>
                    """ + idField + """
                    <input type='text' name='text' placeholder='–¢–µ–∫—Å—Ç –∫–∞—Ä—Ç–æ—á–∫–∏' value='""" + (isEdit ? card.text : "") + """' required><br>
                    <select name='level' required>
                        <option value='1' """ + (isEdit && card.level == 1 ? "selected" : "") + """>1. –ó–Ω–∞–∫–æ–º—Å—Ç–≤–æ (–±–µ–ª—ã–π)</option>
                        <option value='2' """ + (isEdit && card.level == 2 ? "selected" : "") + """>2. –ù–∞—á–∏–Ω–∞–µ–º (–∂—ë–ª—Ç—ã–π)</option>
                        <option value='3' """ + (isEdit && card.level == 3 ? "selected" : "") + """>3. –ü—Ä–∏–∫–æ—Å–Ω–æ–≤–µ–Ω–∏—è (—Ñ–∏–æ–ª–µ—Ç–æ–≤—ã–π)</option>
                        <option value='4' """ + (isEdit && card.level == 4 ? "selected" : "") + """>4. –ü–æ–µ—Ö–∞–ª–∏ (–∫—Ä–∞—Å–Ω—ã–π)</option>
                    </select><br>
                    <button>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                </form>
                <a href='/admin' class='btn'>‚Üê –ù–∞–∑–∞–¥</a>
            </div>
        """;
    }

    private static void log(String msg) {
        String time = LocalDateTime.now().format(java.time.format.DateTimeFormatter.ofPattern("HH:mm:ss"));
        System.out.println("[LOG] " + time + " | " + msg);
        try {
            Files.write(Paths.get("server.log"), (time + " | " + msg + "\n").getBytes(), StandardOpenOption.CREATE, StandardOpenOption.APPEND);
        } catch (Exception e) { e.printStackTrace(); }
    }

    static class Card {
        int id;
        String text;
        int level;

        Card(int id, String text, int level) {
            this.id = id;
            this.text = text;
            this.level = level;
        }
    }
} > "D:\repozit\18+\src\App.java"